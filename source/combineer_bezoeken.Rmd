---
title: "Combineer bezoeken voor zelfde meetnetlocatie binnen zelfde jaar"
output:
  bookdown::html_document2:
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
---

```{r setup, include = FALSE}
library(knitr)
options(knitr.kable.NA = '')

opts_chunk$set(
  echo = FALSE, 
  eval = TRUE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 180 / 25.4,
  fig.height = 120 / 25.4,
  fig.align = "center"
)

```

```{r, cache = FALSE}

library(tidyverse)
library(INBOtheme)
library(sf)
library(conflicted)
library(kableExtra)
library(DT)
library(leaflet)
library(lubridate)
library(units)
library(crosstalk)

conflicts_prefer(dplyr::filter())
```

# Lees analyseset

```{r}
analyseset <- read_sf("../data/ruwe_data/plantenmeetnetten.gpkg", layer = "analyseset")

locaties <- read_sf("../data/ruwe_data/plantenmeetnetten.gpkg", layer = "locaties")
```

# Combineer bezoeken

In sommige gevallen zijn er meerdere bezoeken per meetnetlocatie per jaar.
Het kan dan voorkomen dat een deel van de tellingen overlappen.


```{r}
dubbele_bezoeken <- analyseset %>%
  mutate(jaar = year(datum)) %>%
  group_by(meetnet, locatie, jaar) %>%
  filter(n_distinct(visit_id) > 1) %>%
  ungroup() %>%
  st_transform(crs = 31370)
```




```{r, eval = FALSE}

dist_nearest_point <- function(visit_id_select, observations_all) {
  
  observations_visit_id <- observations_all %>%
    filter(visit_id == visit_id_select)
  
  observations_other <- observations_all %>%
    filter(jaar == observations_visit_id$jaar,
           meetnet == observations_visit_id$meetnet,
           locatie == observations_visit_id$locatie,
           visit_id != observations_visit_id$visit_id) %>%
    select(code_nf = code,
           id_nf = id,
           visit_id_nf = visit_id,
           user_id_nf = user_id,
           datum_nf = datum)
  
  observations_result <- observations_visit_id %>%
    st_join(observations_other, join = st_nearest_feature) %>%
    group_by(id) %>%
    mutate(dist_meter = min(drop_units(st_distance(geom, observations_other))),
           dist_meter = round(dist_meter, 1)) %>%
    ungroup() 
  
  return(observations_result)
            
}

dubbele_bezoeken_distance <- NULL

for (v in unique(dubbele_bezoeken$visit_id)) {
  
  visit_id_distance <- dist_nearest_point(v, dubbele_bezoeken) 
  
  dubbele_bezoeken_distance <- dubbele_bezoeken_distance %>%
    bind_rows(visit_id_distance)
  
}

dubbele_bezoeken_distance <- dubbele_bezoeken_distance %>%
  mutate(verschil_dagen = abs(datum - datum_nf),
         zelde_waarnemer = user_id == user_id_nf)

bezoeken_identiek <- dubbele_bezoeken_distance %>%
  filter(dist_meter == 0,
         code == code_nf,
         datum == datum_nf) %>%
  st_drop_geometry() %>%
  distinct(meetnet, locatie, visit_id, visit_id_nf)
```



Voor een meetnetlocatie met meerdere bezoeken per jaar selecteren we puntlocaties op volgende manier:

+ we leggen een raster van 10 m x 10 m over de meetnetlocatie
+ binnen elke rastercel berekenen we het totaal aantal of de totale oppervlakte per bezoek (op basis van de klassengemiddeldes van de floron-klassen)
+ als er binnen een rastercel observaties zijn van meer dan 1 bezoek, selecteren we de observaties van het bezoek met het hoogste totaal (totaal aantal of totaal oppervlakte) binnen die rastercel

```{r}

buffer = 1000
resolutie = 10

bbox_locaties <- locaties %>%
  filter(is_active) %>%
  filter(locatie %in% dubbele_bezoeken$locatie) %>%
  st_transform(31370) %>%
  group_by(locatie) %>%
  mutate(xmin = st_bbox(geom)[1] - buffer,
         ymin = st_bbox(geom)[2] - buffer,
         xmax = st_bbox(geom)[3] + buffer,
         ymax = st_bbox(geom)[4] + buffer) %>%
  ungroup() %>%
  st_drop_geometry() %>%
  select(meetnet, locatie, xmin, ymin, xmax, ymax)

dubbele_bezoeken_grid <- dubbele_bezoeken %>%
  st_drop_geometry() %>%
  mutate(x = st_coordinates(dubbele_bezoeken)[,1],
         y = st_coordinates(dubbele_bezoeken)[,2]) %>%
  left_join(bbox_locaties, by = c("meetnet", "locatie")) %>%
  mutate(row = floor((x - xmin) / resolutie),
         col = floor((y - ymin) / resolutie),
         cell = str_c(row, "_", col)) 

select_visit_per_cell <- dubbele_bezoeken_grid %>%
  group_by(meetnet, locatie, jaar, visit_id, cell) %>%
  summarise(aantal_tot = sum(aantal_mean),
            n_points = n()) %>%
  ungroup() %>%
  group_by(meetnet, locatie, jaar, cell) %>%
  mutate(n_visits = n_distinct(visit_id),
         rank_aantal = rank(aantal_tot, ties.method = "random"),
         rank_punten = rank(n_points)) %>%
  ungroup() %>% 
  group_by(meetnet, locatie, jaar, cell) %>%
  mutate( selected = rank_aantal == max(rank_aantal)) %>%
  ungroup()

dubbele_bezoeken_selected <- dubbele_bezoeken_grid %>%
  left_join(select(select_visit_per_cell, visit_id, cell, selected), by = c("visit_id", "cell")) 
  
analyseset_combine_visits <- analyseset %>%
  left_join(select(dubbele_bezoeken_selected, id, selected), by = "id") %>%
  mutate(selected = ifelse(is.na(selected), TRUE, selected),
         jaar = year(datum))
```

Onderstaande kaart toont de  meetnetlocaties/jaren waar er een selectie van observaties gebeurde om overlappende tellingen te vermijden. De gele punten zijn de weerhouden observaties en de rode punten zijn de niet weerhouden observaties.


```{r}

locaties_combine_visits <- locaties %>%
  semi_join(dubbele_bezoeken_not_selected, by = c("meetnet", "locatie"))

sd <- analyseset_combine_visits %>%
  semi_join(dubbele_bezoeken_not_selected, by = c("meetnet", "locatie", "jaar")) %>% 
  st_transform(4326) %>%
  SharedData$new()

bscols(
  filter_checkbox("selected", "Observatie geselecteerd", sd, ~ifelse(selected, "Ja", "Nee")),
  filter_select("meetnet", "Selecteer meetnet", sd, ~meetnet),
  filter_slider("jaar", "Selecteer jaar", sd, ~jaar))

sd %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(data = locaties_combine_visits, label = ~locatie, group = "Meetnetlocaties") %>%
  addCircleMarkers(color = ~ifelse(selected, "yellow", "red"), label = ~str_c("id=", id, ": ", meetnet, " ", datum, " ", code), group = "Observaties") %>%
  addLayersControl(
    overlayGroups = c("Observaties", "Meetnetlocaties"),
    options = layersControlOptions(collapsed = FALSE)
  )
```


# Totalen per meetnetlocatie per jaar

```{r}
total_year <- analyseset_combine_visits %>%
  st_drop_geometry() %>%
  group_by(meetnet, locatie, jaar, selected) %>%
  summarise(tot_mean = sum(aantal_mean),
            tot_min = sum(aantal_min),
            tot_max = sum(aantal_max),
            n_punten = n_distinct(id),
            n_visits = n_distinct(visit_id)) %>%
  ungroup()
```

```{r }
total_year %>%
  filter(selected) %>%
  ggplot(aes(x = jaar, y = tot_mean, group = locatie)) +
  geom_point(alpha = 0.5) +
  geom_line(alpha = 0.5) +
  facet_wrap(~meetnet, scales = "free_y")
```


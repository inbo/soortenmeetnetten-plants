---
title: "Combineer bezoeken"
output:
  bookdown::html_document2:
    toc: TRUE
    toc_float:
      collapsed: FALSE
      smooth_scroll: FALSE
---

```{r setup, include = FALSE}
library(knitr)
options(knitr.kable.NA = '')

opts_chunk$set(
  echo = FALSE, 
  eval = TRUE,
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 180 / 25.4,
  fig.height = 120 / 25.4,
  fig.align = "center"
)

```

```{r, cache = FALSE}

library(tidyverse)
library(INBOtheme)
library(sf)
library(conflicted)
library(kableExtra)
library(DT)
library(leaflet)
library(lubridate)
library(units)
library(crosstalk)
library(giscoR)
library(plotly)
library(gridExtra)

conflicts_prefer(dplyr::filter())
```


# Selectie analyseset

In het bestand 'verkenning_ruwe_data.html' wordt de opmaak van de analyseset beschreven 

```{r}
analyseset <- read_sf("../data/plantenmeetnetten.gpkg", layer = "analyseset")

locaties <- read_sf("../data/plantenmeetnetten.gpkg", layer = "locaties")
```

# Combineer bezoeken

In sommige gevallen zijn er meerdere bezoeken per meetnetlocatie per jaar.
Het kan dan voorkomen dat een deel van de tellingen overlappen.

```{r}
dubbele_bezoeken <- analyseset %>%
  mutate(jaar = year(datum)) %>%
  group_by(meetnet, locatie, jaar) %>%
  filter(n_distinct(visit_id) > 1) %>%
  ungroup() %>%
  st_transform(crs = 31370)
```

Voor een meetnetlocatie met meerdere bezoeken per jaar selecteren we puntlocaties op volgende manier:

+ we leggen een raster van 10 m x 10 m over de meetnetlocatie
+ binnen elke rastercel berekenen we het totaal aantal of de totale oppervlakte per bezoek (op basis van de klassengemiddeldes van de floron-klassen)
+ als er binnen een rastercel observaties zijn van meer dan 1 bezoek, selecteren we de observaties van het bezoek met het hoogste totaal (totaal aantal of totaal oppervlakte) binnen die rastercel

```{r}

buffer = 1000
resolutie = 10

bbox_locaties <- locaties %>%
  filter(is_active) %>%
  filter(locatie %in% dubbele_bezoeken$locatie) %>%
  st_transform(31370) %>%
  group_by(locatie) %>%
  mutate(xmin = st_bbox(geom)[1] - buffer,
         ymin = st_bbox(geom)[2] - buffer,
         xmax = st_bbox(geom)[3] + buffer,
         ymax = st_bbox(geom)[4] + buffer) %>%
  ungroup() %>%
  st_drop_geometry() %>%
  select(meetnet, locatie, xmin, ymin, xmax, ymax)

dubbele_bezoeken_grid <- dubbele_bezoeken %>%
  st_drop_geometry() %>%
  mutate(x = st_coordinates(dubbele_bezoeken)[,1],
         y = st_coordinates(dubbele_bezoeken)[,2]) %>%
  left_join(bbox_locaties, by = c("meetnet", "locatie")) %>%
  mutate(row = floor((x - xmin) / resolutie),
         col = floor((y - ymin) / resolutie),
         cell = str_c(row, "_", col)) 

select_visit_per_cell <- dubbele_bezoeken_grid %>%
  group_by(meetnet, locatie, jaar, visit_id, cell) %>%
  summarise(aantal_tot = sum(aantal_mean),
            n_points = n()) %>%
  ungroup() %>%
  group_by(meetnet, locatie, jaar, cell) %>%
  mutate(n_visits = n_distinct(visit_id),
         rank_aantal = rank(aantal_tot, ties.method = "random"),
         rank_punten = rank(n_points)) %>%
  ungroup() %>% 
  group_by(meetnet, locatie, jaar, cell) %>%
  mutate( selected = rank_aantal == max(rank_aantal)) %>%
  ungroup()

dubbele_bezoeken_selected <- dubbele_bezoeken_grid %>%
  left_join(select(select_visit_per_cell, visit_id, cell, selected), by = c("visit_id", "cell")) 
  
analyseset_combine_visits <- analyseset %>%
  left_join(select(dubbele_bezoeken_selected, id, selected), by = "id") %>%
  mutate(selected = ifelse(is.na(selected), TRUE, selected),
         jaar = year(datum)) %>%
  group_by(meetnet, locatie, jaar) %>%
  mutate(doubles_removed = !all(selected)) %>%
  ungroup() %>%
  mutate(code = factor(code, levels = c("0", "A", "B", "C", "D", "E", "F", "G")))
  
check <- dubbele_bezoeken_selected %>%
  group_by(id) %>%
  filter(n() > 1)
```

Onderstaande kaart toont de  meetnetlocaties/jaren waar er een selectie van observaties gebeurde om overlappende tellingen te vermijden. De gele punten zijn de weerhouden observaties en de rode punten zijn de niet weerhouden observaties.


```{r}

analyseset_doubles_removed <- analyseset_combine_visits %>%
  filter(doubles_removed)

locaties_combine_visits <- locaties %>%
  semi_join(st_drop_geometry(analyseset_doubles_removed), by = c("meetnet", "locatie"))

sd <- analyseset_doubles_removed %>%
  st_transform(4326) %>%
  SharedData$new()

bscols(
  filter_checkbox("selected", "Observatie geselecteerd", sd, ~ifelse(selected, "Ja", "Nee")),
  filter_select("meetnet", "Selecteer meetnet", sd, ~meetnet),
  filter_slider("jaar", "Selecteer jaar", sd, ~jaar))

sd %>%
  leaflet() %>%
  addTiles() %>%
  addPolygons(data = locaties_combine_visits, label = ~locatie, group = "Meetnetlocaties") %>%
  addCircleMarkers(color = ~ifelse(selected, "yellow", "red"), 
                   radius = ~ifelse(selected,5, 2), 
                   label = ~str_c("id=", id, ": ", meetnet, " ", datum, " ", code), 
                   group = "Observaties") %>%
  addLayersControl(
    overlayGroups = c("Observaties", "Meetnetlocaties"),
    options = layersControlOptions(collapsed = FALSE)
  )

```

```{r}
total_year <- analyseset_combine_visits %>%
  st_drop_geometry() %>%
  group_by(meetnet, locatie, jaar, selected) %>%
  summarise(tot_mean_selected = sum(aantal_mean),
            tot_min_selected = sum(aantal_min),
            tot_max_selected = sum(aantal_max),
            n_punten_selected = n_distinct(id),
            n_visits_selected = n_distinct(visit_id)) %>%
  ungroup() %>%
  group_by(meetnet, locatie, jaar) %>%
  mutate(tot_mean = sum(tot_mean_selected),
          tot_min = sum(tot_min_selected),
          tot_max = sum(tot_max_selected),
          n_punten = sum(n_punten_selected),
          n_visits = sum(n_visits_selected)) %>%
  ungroup() %>%
  filter(selected)

check_total_year <- total_year %>%
  filter(tot_mean != tot_mean_selected) %>%
  mutate(totaal_ruw = str_c(tot_min, " - ", tot_mean, " - ", tot_max),
         totaal_selected = str_c(tot_min_selected, " - ", tot_mean_selected, " - ", tot_max_selected),
         n_tellingen_verwijderd = n_punten - n_punten_selected) %>%
  select(meetnet, locatie, jaar, "totaal ruw" = totaal_ruw, "n punten ruw" = n_punten, "totaal selected" = totaal_selected, "n tellingen verwijderd" = n_tellingen_verwijderd)
```

In onderstaande tabel vergelijken we de totalen per locatie per jaar voor en na het verwijderen van overlappende tellingen.

Bij het berekenen van de totalen sommeren we de ondergens, het midden en de bovengrens van de floronklassen.

```{r}
check_total_year %>%
  kable(caption = "Totalen (som van klasseondergrens - som van klassemidden - som van klassebovengrens) per locatie per jaar op basis van alle tellingen (totaal_ruw) en na verwijderen na mogelijks overlappende tellingen (totaal_selected)") %>%
  kable_styling()
```

```{r}
analyseset_combine_visits %>%
  filter(selected) %>%
  st_write("../data/plantenmeetnetten.gpkg", "analyseset_preprocessed", delete_layer = TRUE)
```


### Berekening van totalen per locatie en per meetnet

```{r}

duur_cyclus <- 3
start_cyclus <- 2016

analyseset_combine_visits <- analyseset_combine_visits %>%
  mutate(cyclus = ceiling((jaar - start_cyclus + 1) / duur_cyclus)) %>%
  group_by(cyclus) %>%
  mutate(periode = str_c(min(jaar), " - ", max(jaar))) %>%
  ungroup() %>%
  group_by(cyclus, meetnet, locatie) %>%
  mutate(n_jaar_cyclus = n_distinct(jaar)) %>%
  ungroup()

total_year <- analyseset_combine_visits %>%
  st_drop_geometry() %>%
  filter(selected) %>%
  group_by(meetnet, locatie, protocol, cyclus, periode, jaar, selected) %>%
  summarise(tot_mean = sum(aantal_mean),
            tot_min = sum(aantal_min),
            tot_max = sum(aantal_max),
            n_punten = n_distinct(id),
            n_visits = n_distinct(visit_id)) %>%
  ungroup()

```


```{r}

total_year_long <- total_year %>%
  select(meetnet, locatie, jaar, protocol, tot_mean, n_punten) %>%
  pivot_longer(cols = c("tot_mean", "n_punten"), names_to = "variable", values_to = "aantal")

plot_nr <-  total_year_long %>%
  distinct(meetnet, locatie) %>%
  group_by(meetnet) %>%
  mutate(rank_loc = rank(locatie),
         plotnr = ceiling(rank_loc/5)) %>%
  ungroup()

total_year_long <- total_year_long %>%
  left_join(plot_nr, by = c("meetnet", "locatie")) %>%
  mutate(variable = ifelse(variable == "tot_mean",
                           ifelse(protocol == "Vaatplanten - Oppervlakte", "totaal oppervlakte (m²)", "totaal aantal"),
                           "totaal punten"))
```

### Berekening van totalen per cyclus

Twee cycli werden al afgewerkt:

+ 2016 - 2018
+ 2019 - 2021

Als locaties geteld werden in meerdere jaren binnen dezelfde cyclus, selecteren we het jaar met de maximale som van de aantallen of oppervlaktes.

```{r}
total_cyclus <- total_year %>%
  group_by(meetnet, protocol, locatie, cyclus) %>%
  filter(tot_mean == max(tot_mean)) %>%
  ungroup() %>%
  mutate(variable = ifelse(protocol == "Vaatplanten - Oppervlakte", "totaal oppervlakte (m²)", "totaal aantal")) %>%
  mutate(voorkomen = ifelse(tot_mean == 0, "afwezig", "aanwezig"))

analyseset_cyclus <- analyseset_combine_visits %>%
  semi_join(total_cyclus, by = c("meetnet", "locatie", "jaar"))
```


# Overzicht van de resultaten

## Puntwaarnemingen per meetcyclus

```{r}
radius_show <- tibble(code = c("0","A", "B", "C", "D", "E","F","G"),
                      radius = c(1,3,4,5,6,7,9,11) + 2)

data_meetnet <- analyseset_cyclus %>%
  filter(cyclus %in% c(1, 2)) %>%
  left_join(radius_show, by = "code") %>%
  mutate(nulwaarneming = ifelse(code == "0", "0", "A-B-C-D-E-F-G")) 
  
sd <- SharedData$new(data_meetnet)

bscols(widths = c(5, 3, 4),
       filter_select("meetnet", "Soort", sd, ~meetnet),
       filter_checkbox("cyclus", "Meetcyclus", sd, ~periode),
       filter_checkbox("nulwaarneming", "Type waarnemingen", sd, ~nulwaarneming)
  )

leaflet(sd) %>%
  addTiles() %>%
  #addPolygons(data = locaties_meetnet, label = ~locatie) %>%
  addCircleMarkers(color = ~ifelse(cyclus == 1, "#282A72", "#EF972C"),  label = ~str_c(meetnet, " ", code), stroke = FALSE,
                   radius = ~radius, fillOpacity = 0.5)


plot_ly(sd, x = ~code, color = ~periode, colors = c("#282A72", "#EF972C")) %>%
  add_histogram()
```

## Verschillen tussen meetcycli

Hieronder de relatieve verschillen van de totalen op basis van de klassenmiddens.


```{r}

total_meetnet_cyclus <- total_cyclus %>%
  group_by(meetnet, periode, variable, protocol, cyclus) %>%
  summarise(tot_mean = sum(tot_mean),
            tot_max = sum(tot_max),
            tot_min = sum(tot_min)) %>%
  ungroup() %>%
  mutate(voorkomen = ifelse(tot_mean == 0, "afwezig", "aanwezig")) %>%
  filter(cyclus %in% c(1,2))

verschil_meetnet <- total_meetnet_cyclus %>%
  select(-periode, -voorkomen) %>%
  pivot_wider(names_from = "cyclus", values_from = c("tot_mean", "tot_min", "tot_max")) %>%
  mutate(verschil_rel = (tot_mean_2 - tot_mean_1) / tot_mean_1,
         verschil_percent = verschil_rel * 100,
         verschil_rel_log = log(1 + verschil_rel) + 1,
         klasse = ifelse(verschil_rel < -0.25, "--",
                         ifelse(verschil_rel < -0.10, "-",
                                ifelse(verschil_rel < 0.10, "~",
                                      ifelse(verschil_rel < 0.33, "+", "++"))))) 

order_trend <- (verschil_meetnet %>%
  arrange(verschil_rel))$meetnet
```


```{r}
verschil_meetnet %>%
  mutate(verschil_show = str_c( ifelse(verschil_percent > 0, "+", ""), round(verschil_percent), " %")) %>%
  select(soort = meetnet, variabele = variable, "2016 - 2018" = tot_mean_1, "2019 - 2021" = tot_mean_2, "relatief verschil" = verschil_show) %>%
  kable() %>%
  kable_styling()
  
  
```


```{r}
breaks_log <- log(c(0, 0.05, 0.25, 0.5, 0.75, 1, 1.33, 2,  4, 11, 31)) + 1
labels_show <- str_c(c(-100, -95, -75, -50, -25, 0, 33, 100, 300, 1000, 3000), " %")

verschil_meetnet %>%
  mutate(meetnet = factor(meetnet, levels = order_trend)) %>%
  ggplot(aes(x = verschil_rel_log, y = meetnet, label = klasse, colour = klasse)) +
  geom_vline(xintercept = 1, linetype = 2) +
  geom_vline(xintercept = log(0.75) + 1, linetype = 3) +
  geom_vline(xintercept = log(1.33) + 1, linetype = 3) +
  geom_point(aes(colour = klasse), size = 5) +
  geom_text(size = 3, colour = "white") +
  labs(x = "Vreschil tussen periode 2019 - 2021 en periode 2016 - 2018", y = "Soort") +
  scale_x_continuous(breaks = breaks_log, labels = labels_show) +
  # scale_color_manual(values = klasse_color) +
  theme(legend.position = "hide", axis.text.x = element_text(angle = 90))
```

# Resultaten per meetnet

```{r}

locatie_point <- locaties %>%
  st_transform(crs = 31370) %>%
  inner_join(select(total_cyclus, meetnet, locatie, cyclus, tot_mean, periode, voorkomen), by = c("meetnet", "locatie")) %>%
  st_point_on_surface() 

locatie_point_1_2 <- locatie_point %>%
  rename(geometry = geom) %>%
  filter(cyclus <= 2)

```

```{r}
vlaanderen <- giscoR::gisco_get_nuts(country = "Belgium", nuts_level = "2", resolution = "01") %>%
  filter(NUTS_NAME %in% c("Prov. Antwerpen",
                          "Prov. Oost-Vlaanderen",
                          "Prov. West-Vlaanderen",
                          "Prov. Vlaams-Brabant",
                          "Prov. Limburg (BE)")) %>%
  st_transform(crs = 31370)

```

## Totalen per jaar {.tabset}

*Niet in eindrapport*

```{r, fig.width = 10, fig.height= 4, results = 'asis'}
for (soort in unique(total_year_long$meetnet)) {
  
  total_year_soort <- total_year_long %>%
    filter(meetnet == soort)
  
  cat(str_c("\n\n### ", soort, " \n"))

  for (i in unique(total_year_soort$plotnr)) {

    p <- total_year_soort %>%
      filter(plotnr == i) %>%
      mutate(locatie = str_wrap(locatie, width = 15)) %>%
      ggplot(aes(x = jaar, y = aantal, colour = variable)) +
      geom_point() +
      geom_line() +
     # labs(title = str_c(soort, " - ", i)) +
      facet_grid(variable ~ locatie, scales = "free_y") +
      theme(axis.text.x = element_text(angle = 90),
            axis.title.y = element_blank())

    plot(p)

  }
}
```

## Totalen per meetcyclus {.tabset}

```{r, results = 'asis'}

for (soort in unique(total_year_long$meetnet)) {
  
  locatie_point_meetnet <- locatie_point_1_2 %>%
    filter(meetnet == soort) 
  
  variable_select <- total_cyclus %>%
    filter(meetnet == soort) %>%
    select(variable) %>%
    unique()
  
  variable_select2 <- str_remove(variable_select$variable, "totaal ")
  
  cat(str_c("\n\n### ", soort, " \n"))
  
  
  p1 <- ggplot() +
    geom_sf(data = locatie_point_meetnet, aes(size = tot_mean,  colour = voorkomen), alpha = 0.7) +
    geom_sf(data = vlaanderen, alpha = 0.2, colour = "grey") +
   # scale_shape_manual(values = c( 19, 4)) +
    scale_colour_manual(values = c( "aanwezig" = "#282A72", "afwezig" = "black")) +
    facet_wrap(~periode, ncol = 1) +
    theme_void() +
    labs(size = variable_select$variable)
  

  p2 <- total_cyclus %>%
    filter(meetnet == soort) %>%
    filter(cyclus <= 2) %>%
    ggplot(aes(x = periode, y = tot_mean, group = locatie, colour = voorkomen)) +
    geom_point(alpha = 0.7, size = 3) +
    geom_line(linetype = 2, alpha = 0.8, colour = "grey") +
    labs(y = str_c(variable_select$variable, " per locatie")) +
    scale_colour_manual(values = c( "aanwezig" = "#282A72", "afwezig" = "black")) +
    theme(legend.position = "bottom") +
    theme(legend.position = "hide")
  
  
  p3 <- total_meetnet_cyclus %>%
    filter((meetnet == soort)) %>%
    filter(cyclus <= 2) %>%
    filter(cyclus >= 1) %>%
    ggplot(aes(x = periode, y = tot_mean, ymin = tot_min, ymax = tot_max, colour = voorkomen)) +
    geom_point(size = 3) +
    #geom_errorbar(width = 0, size = 7, alpha = 0.3) +
    labs(y = str_c(variable_select$variable, " per meetnet")) +
    scale_colour_manual(values = c( "aanwezig" = "#282A72", "afwezig" = "black")) +
    theme(legend.position = "hide")
  
  p4 <- analyseset_cyclus %>%
    filter(meetnet == soort) %>%
    filter(cyclus <= 2) %>%
    ggplot(aes(x = code, fill = periode)) +
    geom_bar(position = "dodge", ) +
    labs(x = str_c("Floron code - ", variable_select2), y = "Aantal punten") +                     
    scale_x_discrete(drop = FALSE)
  
  cat("\n\n**Distributie Floron-code**")
  
  plot(p4)
  
  cat("\n\n**Totalen per meetlocatie en per meetnet**")
  
  plot(p1)
  
  grid.arrange(p2, p3, ncol = 2)
  
}

```






